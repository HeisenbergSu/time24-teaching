name: Build macOS Version

on:
  workflow_dispatch:  # 手动触发
  push:
    tags:
      - 'v*'  # 发布标签时自动触发

jobs:
  build-macos:
    runs-on: macos-latest
    
    permissions:
      contents: write
      packages: write
      actions: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '16'
    
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm install
    
    - name: Build frontend
      run: |
        cd frontend
        npm run build
    
    - name: Copy frontend to backend
      run: |
        cp -r frontend/dist backend/web
    
    - name: Install backend dependencies
      run: |
        cd backend
        pip3 install -r requirements.txt
    
    - name: Build macOS executable
      run: |
        cd backend
        pyinstaller --noconfirm --clean --onefile --console \
          --name="TimeTeachingSystem" \
          --add-data="web:web" \
          --hidden-import=flask \
          --hidden-import=flask_cors \
          --hidden-import=sqlalchemy \
          app.py
    
    - name: Create macOS release package
      run: |
        mkdir -p release/macOS
        cp backend/dist/TimeTeachingSystem release/macOS/
        chmod +x release/macOS/TimeTeachingSystem
        
        # 创建启动脚本
        cat > release/macOS/启动系统.sh << 'EOF'
        # !/bin/bash
        
        GREEN='\033[0;32m'
        NC='\033[0m'
        
        echo -e "${GREEN}========================================${NC}"
        echo -e "${GREEN}   24时计时法教学系统${NC}"
        echo -e "${GREEN}========================================${NC}"
        echo ""
        echo "正在启动系统，请稍候..."
        echo ""
        
        SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
        (sleep 3 && open http://localhost:5000 2>/dev/null || echo "请手动打开浏览器访问 http://localhost:5000") &
        
        cd "$SCRIPT_DIR"
        ./TimeTeachingSystem
        
        echo ""
        echo "系统已停止运行"
        read -p "按回车键退出..."
        EOF
                
                chmod +x release/macOS/启动系统.sh
            
    - name: Create usage instructions
      run: |
        cat > release/macOS/使用说明.txt << 'EOF'
        ═══════════════════════════════════════════════════
            24时计时法教学系统 - 使用说明 (macOS)
        ═══════════════════════════════════════════════════
        
        【快速开始】
        ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        1. 双击 "启动系统.sh" 文件
           （或在终端中运行: ./启动系统.sh）
        2. 如果提示权限不足，请在终端运行: chmod +x 启动系统.sh
        3. 等待系统启动（会显示终端窗口）
        4. 系统会自动在浏览器中打开，如果没有自动打开，
           请手动访问: http://localhost:5000
        
        【停止系统】
        ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        在终端窗口中按 Ctrl+C，然后关闭窗口
        
        【默认账号】
        ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        教师后台登录：
          - 用户名: teacher
          - 密码: teacher123
        
        ⚠️ 注意：生产环境建议修改默认密码！
        
        【数据存储】
        ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        - 首次运行会自动创建数据库文件 time24_teaching.db
        - 数据库文件会保存在程序同目录下
        - 删除数据库文件会清空所有数据
        
        【系统要求】
        ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        - 操作系统: macOS 10.12 或更高版本
        - 浏览器: Safari、Chrome、Firefox 等现代浏览器
        - 网络: 无需联网（本地运行）
        
        【常见问题】
        ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        1. macOS 安全提示
           问题：提示"无法打开，因为来自身份不明的开发者"
           解决：
           - 右键点击可执行文件，选择"打开" → 点击"打开"确认
           - 或在终端运行: xattr -d com.apple.quarantine TimeTeachingSystem
        
        2. 端口被占用
           解决：关闭占用 5000 端口的其他程序后重试
        
        ═══════════════════════════════════════════════════
        EOF
    
    - name: Upload macOS release
      uses: actions/upload-artifact@v4
      with:
        name: macOS-release
        path: release/macOS
        retention-days: 30
    
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        body: |
          ## 版本 ${{ github.ref_name }}
          
          ### 更新内容
          - 自动化构建发布
          - 包含 macOS 版本
          
          ### 使用说明
          请参考 release 中的使用说明文件
        draft: false
        prerelease: false

