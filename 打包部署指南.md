# 24时计时法教学系统 - 跨平台打包部署指南

## 📋 目录
- [打包概述](#打包概述)
- [Windows 平台打包](#windows-平台打包)
- [macOS 版本打包](#macos-版本打包)
- [客户使用说明](#客户使用说明)
- [系统要求](#系统要求)
- [常见问题](#常见问题)
- [技术细节](#技术细节)

---

## 📦 打包概述

### 打包策略

本打包脚本在 **Windows 系统**上运行，会同时生成：
1. **Windows 版本**：可直接使用的 Windows 可执行程序
2. **macOS 打包工具包**：包含所有必要文件，可在 macOS 系统上快速打包

### 工作原理

由于 PyInstaller 不支持交叉编译，无法在 Windows 上直接生成 macOS 可执行文件。因此采用以下策略：

- ✅ 前端文件在 Windows 上统一构建（Node.js 构建，跨平台）
- ✅ Windows 版本直接在 Windows 上打包完成
- ✅ macOS 版本打包工具包包含：
  - 已构建好的前端静态文件
  - 完整的后端代码
  - macOS 打包脚本和说明
  - 在 macOS 系统上运行打包脚本即可生成 macOS 版本

### 打包流程图

```
Windows 上运行打包脚本
    ↓
1. 构建前端 (Vue) ← 跨平台，无需重新构建
    ↓
2. 准备后端资源
    ↓
3. 打包 Windows 版本 → release/Windows/ (可直接使用)
    ↓
4. 准备 macOS 打包工具包 → release/macOS_打包工具包/
    ↓
将工具包复制到 macOS 系统
    ↓
运行打包脚本 → release/macOS/ (可直接使用)
```

---

## 🪟 Windows 平台打包

### 前置要求

在 Windows 系统上打包需要安装以下工具：

1. **Node.js** (版本 >= 12.0)
   - 下载地址: https://nodejs.org/
   - 安装后验证: 打开命令行，输入 `node --version`

2. **Python** (版本 >= 3.6)
   - 下载地址: https://www.python.org/
   - 安装时**务必勾选** "Add Python to PATH"
   - 安装后验证: 打开命令行，输入 `python --version`

3. **npm** (通常随 Node.js 一起安装)
   - 验证: 打开命令行，输入 `npm --version`

### 执行打包

#### 方法一：使用批处理脚本（推荐）

1. 双击项目根目录下的 `一键打包.bat` 文件
2. 等待打包完成（可能需要 5-10 分钟）
3. 打包完成后，查看 `release` 文件夹

#### 方法二：使用命令行

1. 打开命令行（CMD 或 PowerShell）
2. 进入项目根目录：
   ```bash
   cd D:\code\time24-teaching
   ```
3. 运行打包脚本：
   ```bash
   python build_project.py
   ```
4. 等待打包完成

### 打包过程说明

打包脚本会自动执行以下步骤：

1. ✅ **检查环境** - 验证 Node.js、npm、Python 是否安装
2. ✅ **构建前端** - 编译 Vue 项目为静态文件（`frontend/dist`）
3. ✅ **准备资源** - 将前端文件复制到后端目录（`backend/web`）
4. ✅ **安装依赖** - 安装 Python 后端依赖（如果未安装）
5. ✅ **打包 Windows 版本** - 使用 PyInstaller 打包为 Windows 可执行程序
6. ✅ **准备 macOS 工具包** - 创建 macOS 打包所需的所有文件

### 打包结果

打包完成后，`release` 文件夹结构如下：

```
release/
├── Windows/                    # Windows 版本（可直接使用）
│   ├── TimeTeachingSystem.exe  # 主程序（约 50-100MB）
│   ├── 启动系统.bat            # 一键启动脚本
│   └── 使用说明.txt            # 用户使用说明
│
└── macOS_打包工具包/            # macOS 打包工具包
    ├── backend/                # 后端代码（包含已构建的前端文件）
    ├── 在macOS上打包.sh        # macOS 打包脚本
    └── README_macOS打包说明.txt # macOS 打包说明
```

---

## 🍎 macOS 版本说明

### 三种 macOS 运行方式

我们提供了三种 macOS 版本，满足不同用户的需求：

#### 方式一：macOS Python 脚本版本（**推荐，最简单**）⭐

**优点**：
- ✅ 无需打包环境，只需 Python 3（macOS 通常已预装）
- ✅ 体积小，启动快
- ✅ 易于更新和维护
- ✅ 支持热更新

**使用方法**：
1. 将 `release/macOS_Python版本` 文件夹复制到 macOS 系统
2. 双击 `启动系统.sh` 文件
3. 首次运行会自动安装依赖和初始化数据库
4. 系统会自动在浏览器中打开

**系统要求**：
- macOS 10.12 或更高版本
- Python 3.6 或更高版本（macOS 通常已预装）

#### 方式二：GitHub Actions 自动打包（**推荐给开发者**）🔧

使用 GitHub Actions 在云端 macOS 环境中自动打包，无需本地 macOS 环境。

**使用方法**：
1. 将代码推送到 GitHub
2. 在 GitHub Actions 中手动触发工作流，或推送标签自动触发
3. 下载打包好的 macOS 可执行文件

**详细说明**：
- 工作流文件：`.github/workflows/build-macos.yml`
- 手动触发：GitHub 仓库 → Actions → Build macOS Version → Run workflow
- 自动触发：推送标签（如 `v1.0.0`）时自动打包

#### 方式三：本地打包工具包（**需要 macOS 打包环境**）⚙️

如果需要本地打包，可以使用打包工具包。

**使用方法**：
1. 将 `release/macOS_打包工具包` 文件夹复制到 macOS 系统
2. 打开终端，进入工具包目录
3. 运行：`./在macOS上打包.sh`
4. 打包完成后，在工具包目录下会生成 `macOS` 文件夹

**系统要求**：
- macOS 10.12 或更高版本
- Python 3.6 或更高版本
- pip3（随 Python 3 一起安装）
- PyInstaller（打包脚本会自动安装）

---

## 🚀 客户使用说明

### Windows 用户

#### 快速开始

1. **解压文件**
   - 将 `release/Windows` 文件夹（或压缩包）解压到任意位置
   - 建议放在桌面或 D 盘根目录

2. **启动系统**
   - 双击 `启动系统.bat` 文件
   - 等待系统启动（会显示一个命令行窗口）
   - 系统会自动在浏览器中打开（约 3 秒后）

3. **使用系统**
   - 在浏览器中使用系统
   - 命令行窗口保持打开状态（不要关闭）

4. **停止系统**
   - 在命令行窗口中按 `Ctrl+C`
   - 关闭命令行窗口

### macOS 用户

#### 快速开始

1. **解压文件**
   - 将 `macOS` 文件夹（或压缩包）解压到任意位置
   - 建议放在桌面或应用程序文件夹

2. **首次运行准备**
   - 如果提示"无法打开，因为来自身份不明的开发者"：
     - 右键点击 `TimeTeachingSystem` → 选择"打开" → 点击"打开"确认
     - 或在终端中运行: `xattr -d com.apple.quarantine TimeTeachingSystem`
   
3. **启动系统**
   - **方法一**: 双击 `启动系统.sh` 文件
   - **方法二**: 在终端中运行:
     ```bash
     cd /path/to/macOS
     chmod +x 启动系统.sh
     ./启动系统.sh
     ```
   - 等待系统启动（会显示一个终端窗口）
   - 系统会自动在浏览器中打开（约 3 秒后）

4. **使用系统**
   - 在浏览器中使用系统
   - 终端窗口保持打开状态（不要关闭）

5. **停止系统**
   - 在终端窗口中按 `Ctrl+C`
   - 关闭终端窗口

### 默认账号

**教师后台登录：**
- 用户名: `teacher`
- 密码: `teacher123`

⚠️ **重要提示**：生产环境建议修改默认密码！

### 数据存储

- 首次运行会自动创建数据库文件 `time24_teaching.db`
- 数据库文件会保存在程序同目录下
- 删除数据库文件会清空所有数据（包括学生记录、答题记录等）
- **建议定期备份数据库文件**

---

## 💻 系统要求

### 客户环境要求

#### Windows
- **操作系统**: Windows 7 或更高版本（Windows 10/11 推荐）
- **浏览器**: Chrome、Edge、Firefox 等现代浏览器
- **网络**: 无需联网（本地运行）
- **其他**: 无需安装 Python、Node.js 等开发环境

#### macOS
- **操作系统**: macOS 10.12 (Sierra) 或更高版本
- **浏览器**: Safari、Chrome、Firefox 等现代浏览器
- **网络**: 无需联网（本地运行）
- **其他**: 无需安装 Python、Node.js 等开发环境

### 开发环境要求（仅打包时需要）

#### Windows 打包环境
- Node.js >= 12.0
- Python >= 3.6
- npm（随 Node.js 安装）
- PyInstaller（打包时会自动安装）

#### macOS 打包环境
- Python 3 >= 3.6（通过 Homebrew 安装或系统自带的 Python 3）
- pip3（随 Python 3 安装）

---

## ❓ 常见问题

### 打包相关问题

#### 1. 打包失败 - 提示缺少模块

**问题**: 提示 `ModuleNotFoundError` 或类似错误

**解决方案**:
```bash
# Windows
cd backend
pip install -r requirements.txt

# macOS
cd backend
pip3 install -r requirements.txt
```

#### 2. 前端构建失败

**问题**: 前端构建时出错

**解决方案**:
```bash
# 清理并重新安装前端依赖
cd frontend
rm -rf node_modules  # Windows: rmdir /s /q node_modules
npm install
npm run build
```

#### 3. PyInstaller 打包失败

**问题**: PyInstaller 报错或生成的可执行文件无法运行

**解决方案**:
- 确保已安装 PyInstaller: `pip install pyinstaller` 或 `pip3 install pyinstaller`
- 检查 spec 文件配置是否正确
- 查看错误日志，根据具体错误信息解决

#### 4. macOS 打包时 Python 版本错误

**问题**: macOS 上使用 `python` 命令指向 Python 2.7

**解决方案**:
- 使用 `python3` 命令替代 `python`
- 或在打包脚本中明确使用 `python3`

### 运行相关问题

#### 1. 端口被占用

**问题**: 启动时提示端口 5000 已被占用

**解决方案**:
- 关闭占用 5000 端口的其他程序
- 或修改 `backend/app.py` 中的端口号后重新打包

#### 2. 无法访问页面

**问题**: 浏览器显示无法连接或空白页面

**解决方案**:
- 检查命令行/终端窗口是否显示错误信息
- 确认程序已正常启动（应显示 Flask 启动信息）
- 尝试手动访问: `http://localhost:5000`
- 检查防火墙是否阻止了程序运行

#### 3. 程序无法运行

**Windows**:
- 检查是否被杀毒软件拦截（添加信任）
- 尝试右键"以管理员身份运行"
- 查看是否有错误提示信息
- 检查系统是否缺少必要的运行库（如 Visual C++ Redistributable）

**macOS**:
- 如果提示"无法打开，因为来自身份不明的开发者":
  - 右键点击程序 → 选择"打开" → 点击"打开"确认
  - 或在终端运行: `xattr -d com.apple.quarantine TimeTeachingSystem`
- 在终端中运行查看具体错误信息
- 检查是否缺少权限（在"系统偏好设置" > "安全性与隐私"中设置）

#### 4. 浏览器未自动打开

**问题**: 启动后浏览器没有自动打开

**解决方案**:
- 这是正常的，可以手动访问 `http://localhost:5000`
- 检查系统默认浏览器设置
- macOS 上确保已安装并设置了默认浏览器

#### 5. 数据库相关问题

**问题**: 数据丢失或数据库错误

**解决方案**:
- 检查数据库文件 `time24_teaching.db` 是否存在
- 如果数据库损坏，删除数据库文件后重新运行（会重新创建）
- **重要**: 定期备份数据库文件

#### 6. macOS 终端脚本无法执行

**问题**: 双击 `.sh` 文件无法运行或提示权限不足

**解决方案**:
```bash
# 在终端中运行
cd /path/to/macOS
chmod +x 启动系统.sh
./启动系统.sh
```

---

## 🔧 技术细节

### 打包架构

- **前端**: Vue.js 2.x + Element UI
- **后端**: Flask + SQLAlchemy + SQLite
- **打包工具**: PyInstaller（单文件模式）
- **前端构建**: Vue CLI
- **跨平台支持**: Windows、macOS

### 文件结构

```
time24-teaching/
├── frontend/              # 前端源码
│   ├── src/              # Vue 组件和页面
│   ├── dist/             # 构建后的静态文件（打包时生成）
│   └── package.json      # 前端依赖配置
├── backend/              # 后端源码
│   ├── app.py            # Flask 主程序
│   ├── models.py         # 数据库模型
│   ├── seed_data.py      # 题目数据
│   ├── web/              # 前端静态文件（打包时复制）
│   ├── TimeTeachingSystem.spec  # PyInstaller 配置
│   └── requirements.txt  # Python 依赖
├── build_project.py      # 跨平台打包脚本（Windows 上运行）
├── 一键打包.bat          # Windows 打包快捷方式
└── release/              # 发布包（打包后生成）
    ├── Windows/          # Windows 版本
    │   ├── TimeTeachingSystem.exe
    │   ├── 启动系统.bat
    │   └── 使用说明.txt
    └── macOS_打包工具包/  # macOS 打包工具包
        ├── backend/
        ├── 在macOS上打包.sh
        └── README_macOS打包说明.txt
```

### 打包原理

1. **前端构建**: 使用 `npm run build` 将 Vue 项目编译为静态 HTML/CSS/JS 文件（一次构建，跨平台使用）
2. **资源整合**: 将构建好的前端文件复制到后端目录
3. **Windows 打包**: 使用 PyInstaller 将 Flask 应用及其依赖打包为 Windows 可执行文件
4. **macOS 工具包准备**: 复制后端代码和已构建的前端文件到工具包，创建 macOS 打包脚本
5. **macOS 打包**: 在 macOS 系统上运行打包脚本，使用 PyInstaller 打包为 macOS 可执行文件

### 配置说明

#### 修改端口

如果需要修改默认端口（5000），编辑 `backend/app.py`:

```python
app.run(debug=False, port=5000, host='127.0.0.1')  # 修改 5000 为其他端口
```

然后重新打包。

#### 隐藏控制台窗口

如果需要隐藏控制台窗口（后台运行），修改 `backend/TimeTeachingSystem.spec`:

```python
console=False,  # 改为 False
```

然后重新打包。

#### 添加程序图标

1. 准备一个图标文件：
   - Windows: `.ico` 格式
   - macOS: `.icns` 格式

2. 在 `backend/TimeTeachingSystem.spec` 的 `EXE` 部分添加：
```python
icon='path/to/icon.ico',  # Windows
icon='path/to/icon.icns',  # macOS
```

然后重新打包。

### 性能优化

- **减小文件大小**:
  - 使用虚拟环境打包，只包含必要的依赖
  - 在 spec 文件的 `excludes` 中添加不需要的模块
  - 使用 UPX 压缩（已在配置中启用）

- **启动速度**:
  - 单文件模式启动较慢（需要解压），但部署方便
  - 如需更快的启动速度，可使用 `--onedir` 模式（多文件模式）

---

## 📝 版本历史

- **v2.0.0** (2024)
  - 添加跨平台支持（Windows、macOS）
  - 在 Windows 上打包时同时生成 Windows 版本和 macOS 打包工具包
  - 前端文件一次构建，跨平台使用
  - 完整的 macOS 打包工具包和脚本

- **v1.0.0** (2024)
  - 初始版本
  - 支持前后端一体化打包（仅 Windows）
  - 一键启动功能
  - 自动打开浏览器

---

## 📞 技术支持

如有问题，请检查：

1. **打包日志**: 查看打包过程中的错误信息
2. **运行日志**: 查看命令行/终端窗口中的输出信息
3. **浏览器控制台**: 按 F12 打开开发者工具查看错误
4. **系统日志**: 
   - Windows: 事件查看器
   - macOS: 控制台应用

---

**最后更新**: 2024年  
**版本**: 2.0.0  
**打包平台**: Windows  
**支持平台**: Windows、macOS
